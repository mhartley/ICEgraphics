<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>ICE Arrests</title>

    <!-- Custom CSS -->
    <link href="styles.css" rel="stylesheet">

    <!-- required for mapbox -->

    <link href="https://api.mapbox.com/mapbox.js/v2.2.2/mapbox.css" rel="stylesheet">



</head>


<body>

<h1>Since October 13 2016 to May 8 2017, ICE completed 54 courthouse arrests</h1>   
<div id = 'timeline-arrests'></div>

<h3>Arrests by County</h3>

<div class="mapwrapper">
    <div id='map'></div>
</div>

<h3>Arrests by Conviction Date</h3>
<div id = 'barchart'><svg height="500" width = "650"></svg></div>

<h3>Arrests by Offense Type</h3>
 <div id = 'arcs'></div>

</body>


    <!-- d3 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/4.11.0/d3.js"></script>   

    <!-- mapbox scripts -->
    <script src="https://api.mapbox.com/mapbox.js/v2.2.2/mapbox.js"></script>
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.40.1/mapbox-gl.js'></script>

    <!-- jquery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>


<script>

    function equal_success_columns() {
        var box_height = $('#success-vision').height();
        $('.success-vision').css('height', (box_height + (box_height * .1)).toString() + 'px');
    };

    function equal_feature_columns() {
        var box_height = $('.feature-row').height();
        console.log('box_height' + box_height)
        $('.hero-feature').css('height', (box_height - (box_height * .3)).toString() + 'px');
    };

    function timeline(div) {

        var width = 1000;
        var height = 250;
        var padding = 120;
        var dotmargintop = 11;
        var dotmarginbottom = 15;

        var svg = d3.select('#' + div).append('svg')
            .attr('width', width)
            .attr('height', height)
            .append('g');
        // .attr('transform', 'translate(10,100)');


        var mindate = new Date(2016, 9, 1),
            maxdate = new Date(2017, 5, 1);

        var counties = ['A', 'D', 'J']; //counties in which the arrests have occured
        var countyDict = {
            'A': 'Arapahoe County',
            'D': 'Denver County',
            'J': 'Jefferson County'
        }

        var timeScale = d3.scaleTime()
            .domain([mindate, maxdate]) // values between for month of january
            .range([35, width]); // map these the the chart width = total width minus padding at both sides

        var yScale = d3.scaleOrdinal()
            .domain(counties)
            .range([(height / 2) - dotmargintop, (height / 2) + dotmarginbottom, (height / 2) + dotmarginbottom]);

        var dotScale = d3.scaleLinear()
            .domain([0, 10])
            .range([0, 30]);


        var orientText = d3.scaleOrdinal()
            .domain(counties)
            .range([-90, 90, 90]);

        var eventColor = d3.scaleOrdinal()
            .domain(["misdo", "felony"])
            .range(["#67a9cf", "#ef8a62"]);

        console.log('orient text');
        console.log(orientText('D'));


        var testrotate = orientText('J');

        //make the axis    

        var timeaxis = d3.axisBottom(timeScale)
            .ticks(d3.timeMonth.every(1))
            .tickFormat(d3.timeFormat('%b'))

        svg.append('g')
            .attr('class', 'timescale')
            .call(timeaxis)
            .attr('transform', 'translate(0,' + height / 2 + ')');

        d3.selectAll('.timescale .tick text')
            .attr('dy', '.3em')
            .attr('dx', '1.5em');

        var tooltip = d3.select("body").append("div").attr("class", "toolTip");

        var xval = function(d) {
            return d.arrDate;
        };
        var mapx = function(d) {
            return timeScale(d.arrDate);
        };
        var yval = function(d) {
            return d.category;
        };
        var mapy = function(d) {
            return yScale(yval(d));
        };
        var orient = function(d) {
            return 'rotate(' + orientText(yval(d)) + ')'
        }


        d3.csv('icearrests.csv', function(error, data) {
            if (error) return error;

            data.forEach(function(d) {
                d.convictYear = +d.convictYear;
                d.arrDate = d3.timeParse("%Y-%m-%d")(d.arrDate);
                d.ctype = d.ctype.toString();
            });

            //draw things
            var eventdot = svg.selectAll('.event')
                .data(data)
                .enter().append('g')
                .attr('transform', function(d) {
                    return 'translate(' + mapx(d) + ',' + mapy(d) + ')'
                })
                .attr('class', 'event');

            eventdot.append('circle')
                .attr('r', '6px')
                .attr('fill', function(d) {
                    return eventColor(d.ctype)
                })
                .attr('stroke', function(d) {
                    return eventColor(d.ctype)
                })
                .on("mousemove", function(d) {
                    tooltip
                        .style("left", d3.event.pageX - 50 + "px")
                        .style("top", d3.event.pageY - 100 + "px")
                        .style("display", "inline-block")
                        .html("<b>" + d.arrDate.toLocaleDateString() + "</b><br />" + countyDict[d.cntyCode] + ' Courthouse<br/>' + d.crime + '<br/> Convicted:' + (d.convictYear > 0 ? d.convictYear : "Pending"));
                })
                .on("mouseout", function(d) {
                    tooltip.style("display", "none");
                });


            eventdot.append('text')
                .attr('text-anchor', 'left')
                .attr('transform', function(d) {
                    return orient(d)
                })
                .attr('dx', '.7em')
                .attr('dy', '-.2em')
                .attr('font-size', '10px')
                .attr('fill', function(d) {
                    return eventColor(d.ctype)
                })
                .text(function(d) {
                    return d.arrDate.toLocaleDateString() 
                });
        }); //end .csv

        svg.selectAll('g.event')

        //LEGEND
        var legend = d3.select('#timeline-arrests svg').select('.legend')
            .append('g')
       
        legend.append('circle')
            .attr('r', '6px')
    }; //end timeline

    timeline("timeline-arrests");



d3.json('counties.json', function(error, data) {


   
   console.log(data);
    mapboxgl.accessToken = 'pk.eyJ1IjoibW9yZ2FuaGFydGxleSIsImEiOiJjajU4am0yNnowMGJhMnFsZDZyMXZmZHV2In0.w8sQZ86LGnVscOlkG6wNDw';
        var map = new mapboxgl.Map({
        container: 'map', // container id
        style: 'mapbox://styles/mapbox/light-v9', // stylesheet location
        center: [-104.6, 39.5], // starting position [lng, lat]
        zoom: 7, // starting zoom
        minZoom: 7,
        maxZoom: 7
    });

map.on("load", function() {
       map.addSource("metrocounties", {
        "type": "geojson",
        "data": data  });

var countyLayer = map.addLayer({
        "id": "county",
        "type": "fill",
        "source": "metrocounties",
        "paint": {
            "fill-color": {
             property: 'arrests',
             stops: [[0, "#dadaeb"], [18, "#756bb1"], [30,"#54278f"]]
            },
            "fill-opacity": .5
        },
    });

var popup = new mapboxgl.Popup({
        closeButton: false,
        closeOnClick: false
    });

    map.on('mouseenter', 'county', function(e) {
        // Change the cursor style as a UI indicator.
        map.getCanvas().style.cursor = 'pointer';
        console.log(e);

        // Populate the popup and set its coordinates
        // based on the feature found.
        popup.setLngLat(e.lngLat)
            .setHTML("<b>" + e.features[0].properties.name + "</b><br />arrests: " + e.features[0].properties.arrests)
            .addTo(map);
    });

    map.on('mouseleave', 'county', function() {
        map.getCanvas().style.cursor = '';
        popup.remove();
    });




}); //map.on load



}); //d3.json



///BAR CHART

var basewidth = d3.select('#barchart').clientWidth;
var baseheight = d3.select('#barchart').clientHeight;

var svg = d3.select("#barchart svg"),
    margin = {top: 20, right: 20, bottom: 30, left: 40},
    width = +svg.attr("width") - margin.left - margin.right,
    height = +svg.attr("height") - margin.top - margin.bottom;

var x = d3.scaleBand().rangeRound([0, width]).padding(0.1),
    y = d3.scaleLinear().rangeRound([height, 0]);

var g = svg.append("g")
    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

d3.csv("arrestsbyconviction.csv", function(error, data) {
  if (error) throw error;

  data.forEach(function(d){
    d.arrests = +d.arrests;
    console.log(d)
  });

  x.domain(data.map(function(d) { return d.convictYear; }));
  y.domain([0, d3.max(data, function(d) { return d.arrests; })]);
  y.range()


  var tooltip = d3.select('.toolTip');

  g.append("g")
      .attr("class", "axis axis--x")
      .attr("transform", "translate(0," + height + ")")
      .call(d3.axisBottom(x));

  g.append("g")
      .attr("class", "axis axis--y")
      .call(d3.axisLeft(y).ticks(10))
    .append("text")
      .attr("transform", "rotate(-90)")
      .attr("y", 6)
      .attr("dy", "0.71em")
      .attr("text-anchor", "end")
      .text("Frequency");

  g.selectAll(".bar")
    .data(data)
    .enter().append("rect")
      .attr("class", "bar")
      .attr("x", function(d) { return x(d.convictYear); })
      .attr("y", function(d) { return y(d.arrests); })
      .attr("width", x.bandwidth())
      .attr("height", function(d) { return height - y(d.arrests); })
      .on("mousemove", function(d) {
        tooltip
            .style("left", d3.event.pageX - 50 + "px")
            .style("top", d3.event.pageY - 100 + "px")
            .style("display", "inline-block")
            .html(d.arrests);
    })
    .on("mouseout", function(d) {
        tooltip.style("display", "none");
    });

}); //d3.csv

progress_arcs('#arcs', 36, 16);

function progress_arcs(chart_id, misdo, felony) {


        var scale = d3.scaleLinear()
            .domain([0, 100])
            .range([0, 2 * Math.PI]);


        var percentComplete = Math.round((misdo / (misdo + felony)*100)),
            percentCompleteInner = Math.round((felony / (misdo + felony)*100))

        var endAngle = scale(percentComplete);
        var innerEndAngle = scale(percentCompleteInner);

        var svg = d3.select(chart_id)
            .append("svg")
            .attr("width", 400)
            .attr("height", 400)
            .append("g")
            .attr("transform", "translate(200,200)");

        

        var innerarc = d3.arc()
            .innerRadius(110)
            .outerRadius(145)
            .startAngle(0)
            .endAngle(innerEndAngle);

        var arc = d3.arc()
            .innerRadius(150)
            .outerRadius(185)
            .startAngle(0)
            .endAngle(endAngle);

        var outerfullarc = d3.arc()
            .innerRadius(189)
            .outerRadius(192)
            .startAngle(0)
            .endAngle(Math.PI * 2);

        var outerfullpath = svg.append("path")
            .attr("class", "outerfullarc")
            .attr("d", outerfullarc);

        var path = svg.append("path")
            .attr("class", "arc");

        path
            .transition()
            .duration(800)
            .attr("d", arc);


        path
            .on("mouseover", function(d) {
                svg.append('text')
                .attr('text-anchor', 'middle')
                .attr('class', 'progress_arc_text')
                .attr('dy', '.35em')
                .text(misdo.toString())
                })
            .on("mouseout", function(d) {
               d3.select('.progress_arc_text').remove();
            });

        var innerpath = svg.append("path")
            .attr("class", "innerarc");
        
        innerpath   
            .transition()
            .duration(1100)
            .attr("d", innerarc);
        

        innerpath.on("mouseover", function(d) {
            svg.append('text')
            .attr('text-anchor', 'middle')
            .attr('class', 'progress_arc_text')
            .attr('dy', '.35em')
            .text(felony.toString())
            })
            .on("mouseout", function(d) {
               d3.select('.progress_arc_text').remove();
            });


    //     var text = 
    // };
}


</script>

</body>

</html>






